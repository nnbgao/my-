#include <Arduino.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <driver/i2s.h>

// --- 1. CẤU HÌNH WIFI & TELEGRAM ---
const char* ssid = "TEN_WIFI_NHA_BAN";
const char* password = "MAT_KHAU_WIFI";
const char* botToken = "8521958601:AAF3a6g7xJNuRWq3ymr6CcaDS5X2sU2-aFM"; 
const char* chatID = "8519338843"; 

// --- 2. CẤU HÌNH PIN ---
#define I2S_SD      10
#define I2S_WS      11
#define I2S_SCK     12
#define PIN_MIC_L_POWER  4 

// --- 3. CẤU HÌNH ÂM THANH ---
#define SAMPLE_RATE     16000
#define RECORD_TIME_SEC 2
#define BIT_PER_SAMPLE  16
// Tổng số mẫu = 16000 mẫu/s * 2s = 32000 mẫu
#define TOTAL_SAMPLES   (SAMPLE_RATE * RECORD_TIME_SEC)
// Kích thước dữ liệu (bytes) = Số mẫu * 2 (vì 16bit = 2 bytes)
#define DATA_SIZE       (TOTAL_SAMPLES * 2)

// Buffer lưu dữ liệu thô (cấp phát tĩnh để tránh phân mảnh RAM)
int16_t audioBuffer[TOTAL_SAMPLES];

// Cấu trúc Wav Header (44 bytes)
struct WavHeader {
  char riff[4];           // "RIFF"
  uint32_t overallSize;   // File size - 8
  char wave[4];           // "WAVE"
  char fmtChunkMarker[4]; // "fmt "
  uint32_t lengthOfFmt;   // 16
  uint16_t formatType;    // 1 (PCM)
  uint16_t channels;      // 1 (Mono)
  uint32_t sampleRate;    // 16000
  uint32_t byteRate;      // sampleRate * bytesPerSample * channels
  uint16_t blockAlign;    // bytesPerSample * channels
  uint16_t bitsPerSample; // 16
  char dataChunkHeader[4];// "data"
  uint32_t dataSize;      // Kích thước dữ liệu âm thanh
};

// Cấu hình I2S
i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
    .sample_rate = SAMPLE_RATE,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT, // Mono Mic Trái
    .communication_format = I2S_COMM_FORMAT_I2S,
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = 64,
    .use_apll = false
};

i2s_pin_config_t pin_config = {
    .bck_io_num = I2S_SCK,
    .ws_io_num = I2S_WS,
    .data_out_num = I2S_PIN_NO_CHANGE,
    .data_in_num = I2S_SD
};

// --- HÀM KHỞI TẠO I2S ---
void setupI2S() {
    i2s_driver_install(I2S_NUM_0, &i2s_config, 0, NULL);
    i2s_set_pin(I2S_NUM_0, &pin_config);
}

// --- HÀM TẠO HEADER WAV ---
WavHeader createWavHeader(int sampleRate, int dataSize) {
    WavHeader header;
    memcpy(header.riff, "RIFF", 4);
    header.overallSize = dataSize + 36;
    memcpy(header.wave, "WAVE", 4);
    memcpy(header.fmtChunkMarker, "fmt ", 4);
    header.lengthOfFmt = 16;
    header.formatType = 1; // PCM
    header.channels = 1;   // Mono
    header.sampleRate = sampleRate;
    header.bitsPerSample = 16;
    header.byteRate = sampleRate * 1 * 2; // rate * channels * bytes per sample
    header.blockAlign = 2; // channels * bytes per sample
    memcpy(header.dataChunkHeader, "data", 4);
    header.dataSize = dataSize;
    return header;
}

// --- HÀM THU ÂM ---
void recordAudio() {
    Serial.println("--- Bắt đầu thu âm 2s ---");
    digitalWrite(PIN_MIC_L_POWER, HIGH);
    delay(50); 
    i2s_zero_dma_buffer(I2S_NUM_0);

    size_t bytesRead;
    // Đọc trực tiếp vào audioBuffer
    // Lưu ý: i2s_read đọc theo byte, buffer là int16_t nên size là TOTAL_SAMPLES * 2
    i2s_read(I2S_NUM_0, (char*)audioBuffer, DATA_SIZE, &bytesRead, portMAX_DELAY);
    
    digitalWrite(PIN_MIC_L_POWER, LOW);
    Serial.println("--- Đã thu xong ---");
}

// --- HÀM GỬI FILE WAV LÊN TELEGRAM ---
void sendVoiceToTelegram() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("Mất WiFi, đang kết nối lại...");
        WiFi.reconnect();
        delay(2000);
        if (WiFi.status() != WL_CONNECTED) return;
    }

    WiFiClientSecure client;
    client.setInsecure();
    client.setTimeout(10000); // 10s timeout cho việc upload

    Serial.println("Đang upload file lên Telegram...");

    if (client.connect("api.telegram.org", 443)) {
        // Tạo Boundary ngẫu nhiên
        String boundary = "------------------------Esp32Boundary";
        
        // Chuẩn bị Header của file WAV
        WavHeader wavHead = createWavHeader(SAMPLE_RATE, DATA_SIZE);

        // Body phần đầu (Metadata)
        String head = "--" + boundary + "\r\n" +
                      "Content-Disposition: form-data; name=\"audio\"; filename=\"voice.wav\"\r\n" +
                      "Content-Type: audio/x-wav\r\n\r\n";
        
        // Body phần đuôi
        String tail = "\r\n--" + boundary + "--\r\n";

        // Tính tổng dung lượng Content-Length
        // = Head + WavHeader (44 bytes) + RawData + Tail
        size_t contentLength = head.length() + 44 + DATA_SIZE + tail.length();

        // Gửi HTTP Header
        client.println("POST /bot" + String(botToken) + "/sendAudio?chat_id=" + String(chatID) + " HTTP/1.1");
        client.println("Host: api.telegram.org");
        client.println("Content-Type: multipart/form-data; boundary=" + boundary);
        client.println("Content-Length: " + String(contentLength));
        client.println("Connection: close");
        client.println(); // Dòng trống kết thúc header

        // Gửi HTTP Body
        // 1. Gửi Head text
        client.print(head);
        
        // 2. Gửi Wav Header (Binary)
        client.write((uint8_t*)&wavHead, sizeof(wavHead));
        
        // 3. Gửi Dữ liệu âm thanh (Binary)
        // Gửi từng chunk nhỏ để tránh lỗi đường truyền
        client.write((uint8_t*)audioBuffer, DATA_SIZE);

        // 4. Gửi Tail
        client.print(tail);

        Serial.println("Đã gửi xong data. Đang chờ phản hồi...");

        // Đọc phản hồi (quan trọng để biết thành công hay thất bại)
        while (client.connected()) {
            String line = client.readStringUntil('\n');
            if (line == "\r") break; // Hết header
        }
        // Đọc 1 chút body response để clear buffer
        client.readStringUntil('}'); 
        Serial.println("Upload hoàn tất!");
        
        client.stop();
    } else {
        Serial.println("Kết nối server thất bại");
    }
}

void setup() {
    Serial.begin(115200);
    
    // Cấu hình Mic
    pinMode(PIN_MIC_L_POWER, OUTPUT);
    digitalWrite(PIN_MIC_L_POWER, LOW);

    // Kết nối WiFi (giữ luôn kết nối)
    Serial.print("Kết nối WiFi");
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(500); Serial.print(".");
    }
    Serial.println("\nWiFi OK!");

    setupI2S();
}

void loop() {
    // 1. Thu âm
    recordAudio();

    // 2. Gửi file
    sendVoiceToTelegram();

    // 3. Nghỉ 1 chút (tránh spam quá nhanh làm Telegram chặn)
    Serial.println("Nghỉ 2s trước khi thu tiếp...");
    delay(2000);
}
