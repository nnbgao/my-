#include <Arduino.h>
#include <driver/i2s.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <SPIFFS.h>

// ===== Cáº¤U HÃŒNH WIFI =====
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// ===== GOOGLE APPS SCRIPT URL =====
const char* scriptURL = "https://script.google.com/macros/s/AKfycbwVtT6u5jbGQ95iUBSzG7vOMI5s0f5plDMqMEuBqNAn5_iUC0bdYkFa9SKv80SI69im/exec";

// ===== CHÃ‚N Káº¾T Ná»I 2 MIC INMP441 =====
// MIC 1 (TrÃ¡i - Primary)
#define I2S_WS_1    15
#define I2S_SD_1    32
#define I2S_SCK_1   14

// MIC 2 (Pháº£i - Reference cho ANC)
#define I2S_WS_2    25
#define I2S_SD_2    33
#define I2S_SCK_2   26

// ===== Cáº¤U HÃŒNH GHI Ã‚M =====
#define SAMPLE_RATE   16000
#define RECORD_TIME   5
#define I2S_PORT_1    I2S_NUM_0
#define I2S_PORT_2    I2S_NUM_1
#define BUFFER_SIZE   512

// ===== Cáº¤U HÃŒNH NOISE CANCELLING =====
#define ANC_ENABLE true              // Báº­t/táº¯t ANC
#define NOISE_GATE_THRESHOLD 400     // NgÆ°á»¡ng lá»c nhiá»…u (tháº¥p hÆ¡n Ä‘á»ƒ giá»¯ giá»ng giÃ¡o viÃªn)
#define ADAPTIVE_FILTER_SIZE 48      // TÄƒng lÃªn Ä‘á»ƒ lá»c tá»‘t hÆ¡n tiáº¿ng á»“n ngoÃ i
#define SMOOTHING_FACTOR 0.92        // Giáº£m xuá»‘ng Ä‘á»ƒ pháº£n á»©ng nhanh vá»›i giá»ng nÃ³i
#define MIC_DISTANCE_CM 300          // Khoáº£ng cÃ¡ch 2 mic: ~3m (Ä‘iá»u chá»‰nh theo phÃ²ng)

// Bá»™ lá»c thÃ­ch nghi LMS (Least Mean Squares)
class AdaptiveFilter {
private:
  float weights[ADAPTIVE_FILTER_SIZE];
  float buffer[ADAPTIVE_FILTER_SIZE];
  float learningRate;
  int bufferIndex;
  
public:
  AdaptiveFilter(float lr = 0.01) : learningRate(lr), bufferIndex(0) {
    for (int i = 0; i < ADAPTIVE_FILTER_SIZE; i++) {
      weights[i] = 0.0f;
      buffer[i] = 0.0f;
    }
  }
  
  // Xá»­ lÃ½ noise cancelling
  int16_t process(int16_t primary, int16_t reference) {
    // ThÃªm reference vÃ o buffer
    buffer[bufferIndex] = (float)reference;
    
    // TÃ­nh output cá»§a bá»™ lá»c
    float filterOutput = 0.0f;
    for (int i = 0; i < ADAPTIVE_FILTER_SIZE; i++) {
      int idx = (bufferIndex - i + ADAPTIVE_FILTER_SIZE) % ADAPTIVE_FILTER_SIZE;
      filterOutput += weights[i] * buffer[idx];
    }
    
    // TÃ­nh error (nhiá»…u cÃ²n láº¡i)
    float error = (float)primary - filterOutput;
    
    // Cáº­p nháº­t weights (LMS algorithm)
    for (int i = 0; i < ADAPTIVE_FILTER_SIZE; i++) {
      int idx = (bufferIndex - i + ADAPTIVE_FILTER_SIZE) % ADAPTIVE_FILTER_SIZE;
      weights[i] += learningRate * error * buffer[idx];
    }
    
    bufferIndex = (bufferIndex + 1) % ADAPTIVE_FILTER_SIZE;
    
    // Tráº£ vá» tÃ­n hiá»‡u Ä‘Ã£ lá»c nhiá»…u
    return (int16_t)error;
  }
};

// Noise Gate - Loáº¡i bá» tÃ­n hiá»‡u yáº¿u
class NoiseGate {
private:
  int16_t threshold;
  float smoothedLevel;
  
public:
  NoiseGate(int16_t thresh) : threshold(thresh), smoothedLevel(0) {}
  
  int16_t process(int16_t sample) {
    // TÃ­nh RMS mÆ°á»£t
    float level = abs(sample);
    smoothedLevel = SMOOTHING_FACTOR * smoothedLevel + (1 - SMOOTHING_FACTOR) * level;
    
    // Ãp dá»¥ng gate
    if (smoothedLevel < threshold) {
      return 0;
    }
    return sample;
  }
  
  void setThreshold(int16_t thresh) {
    threshold = thresh;
  }
};

// Spectral Subtraction - Giáº£m nhiá»…u trong miá»n táº§n sá»‘
class SpectralSubtraction {
private:
  float noiseProfile[BUFFER_SIZE];
  int profileSamples;
  bool profileReady;
  
public:
  SpectralSubtraction() : profileSamples(0), profileReady(false) {
    for (int i = 0; i < BUFFER_SIZE; i++) {
      noiseProfile[i] = 0;
    }
  }
  
  // Thu tháº­p noise profile (cháº¡y trong im láº·ng)
  void collectNoiseProfile(int16_t* samples, int count) {
    if (profileSamples < 5) {  // Thu tháº­p 5 frame
      for (int i = 0; i < count && i < BUFFER_SIZE; i++) {
        noiseProfile[i] += abs(samples[i]);
      }
      profileSamples++;
      if (profileSamples >= 5) {
        // TÃ­nh trung bÃ¬nh
        for (int i = 0; i < BUFFER_SIZE; i++) {
          noiseProfile[i] /= 5.0f;
        }
        profileReady = true;
      }
    }
  }
  
  // Ãp dá»¥ng spectral subtraction
  void process(int16_t* samples, int count) {
    if (!profileReady) return;
    
    for (int i = 0; i < count; i++) {
      float magnitude = abs(samples[i]);
      float cleanMagnitude = magnitude - noiseProfile[i % BUFFER_SIZE];
      
      if (cleanMagnitude < 0) cleanMagnitude = 0;
      
      // Giá»¯ dáº¥u cá»§a signal
      samples[i] = (samples[i] >= 0) ? (int16_t)cleanMagnitude : -(int16_t)cleanMagnitude;
    }
  }
  
  bool isReady() { return profileReady; }
};

// WAV Header
typedef struct {
  char riff[4];
  uint32_t fileSize;
  char wave[4];
  char fmt[4];
  uint32_t fmtSize;
  uint16_t audioFormat;
  uint16_t channels;
  uint32_t sampleRate;
  uint32_t byteRate;
  uint16_t blockAlign;
  uint16_t bitsPerSample;
  char data[4];
  uint32_t dataSize;
} WAVHeader;

// Khá»Ÿi táº¡o cÃ¡c bá»™ lá»c ANC
AdaptiveFilter adaptiveFilter(0.005);  // Learning rate tháº¥p cho á»•n Ä‘á»‹nh
NoiseGate noiseGate(NOISE_GATE_THRESHOLD);
SpectralSubtraction spectralSubtractor;

void setupI2S(i2s_port_t port, int ws, int sd, int sck) {
  i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
    .sample_rate = SAMPLE_RATE,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_32BIT,
    .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
    .communication_format = I2S_COMM_FORMAT_I2S,
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = BUFFER_SIZE,
    .use_apll = false,
    .tx_desc_auto_clear = false,
    .fixed_mclk = 0
  };

  i2s_pin_config_t pin_config = {
    .bck_io_num = sck,
    .ws_io_num = ws,
    .data_out_num = I2S_PIN_NO_CHANGE,
    .data_in_num = sd
  };

  i2s_driver_install(port, &i2s_config, 0, NULL);
  i2s_set_pin(port, &pin_config);
  i2s_zero_dma_buffer(port);
}

void createWAVHeader(WAVHeader* header, uint32_t dataSize) {
  memcpy(header->riff, "RIFF", 4);
  header->fileSize = dataSize + 36;
  memcpy(header->wave, "WAVE", 4);
  memcpy(header->fmt, "fmt ", 4);
  header->fmtSize = 16;
  header->audioFormat = 1;
  header->channels = 1;  // Mono sau khi ANC
  header->sampleRate = SAMPLE_RATE;
  header->bitsPerSample = 16;
  header->byteRate = SAMPLE_RATE * 2;
  header->blockAlign = 2;
  memcpy(header->data, "data", 4);
  header->dataSize = dataSize;
}

// Thu tháº­p noise profile trong 1 giÃ¢y Ä‘áº§u
void calibrateNoiseProfile() {
  Serial.println("ğŸ”‡ Äang thu tháº­p noise profile...");
  Serial.println("   (Giá»¯ im láº·ng trong 1 giÃ¢y)");
  
  int32_t buffer1[BUFFER_SIZE];
  int32_t buffer2[BUFFER_SIZE];
  int16_t samples[BUFFER_SIZE];
  size_t bytesRead1, bytesRead2;
  
  int calibrationFrames = SAMPLE_RATE / BUFFER_SIZE;  // 1 giÃ¢y
  
  for (int frame = 0; frame < calibrationFrames; frame++) {
    i2s_read(I2S_PORT_1, buffer1, BUFFER_SIZE * 4, &bytesRead1, portMAX_DELAY);
    i2s_read(I2S_PORT_2, buffer2, BUFFER_SIZE * 4, &bytesRead2, portMAX_DELAY);
    
    size_t samplesRead = bytesRead1 / 4;
    for (int i = 0; i < samplesRead; i++) {
      samples[i] = (buffer1[i] >> 16) & 0xFFFF;
    }
    
    spectralSubtractor.collectNoiseProfile(samples, samplesRead);
    
    if (frame % (calibrationFrames / 5) == 0) {
      Serial.print("â–“");
    }
  }
  
  Serial.println();
  Serial.println("âœ… Noise profile Ä‘Ã£ sáºµn sÃ ng!");
}

void recordAudioWithANC(const char* filename) {
  File file = SPIFFS.open(filename, FILE_WRITE);
  if (!file) {
    Serial.println("âŒ Lá»—i: KhÃ´ng thá»ƒ táº¡o file!");
    return;
  }

  WAVHeader header;
  file.write((uint8_t*)&header, sizeof(WAVHeader));

  int32_t buffer1[BUFFER_SIZE];
  int32_t buffer2[BUFFER_SIZE];
  int16_t processedBuffer[BUFFER_SIZE];
  size_t bytesRead1, bytesRead2;
  uint32_t totalDataSize = 0;
  
  uint32_t totalSamples = SAMPLE_RATE * RECORD_TIME;
  uint32_t samplesRecorded = 0;

  Serial.println("ğŸ™ï¸  Báº®T Äáº¦U GHI Ã‚M Vá»šI ANC...");
  Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  unsigned long startTime = millis();
  int noiseCancelledSamples = 0;

  while (samplesRecorded < totalSamples) {
    // Äá»c tá»« cáº£ 2 mic
    i2s_read(I2S_PORT_1, buffer1, BUFFER_SIZE * 4, &bytesRead1, portMAX_DELAY);
    i2s_read(I2S_PORT_2, buffer2, BUFFER_SIZE * 4, &bytesRead2, portMAX_DELAY);
    
    size_t samplesRead = bytesRead1 / 4;
    
    // Xá»­ lÃ½ tá»«ng sample vá»›i ANC
    for (int i = 0; i < samplesRead; i++) {
      int16_t primary = (buffer1[i] >> 16) & 0xFFFF;
      int16_t reference = (buffer2[i] >> 16) & 0xFFFF;
      
      int16_t cleaned = primary;
      
      if (ANC_ENABLE) {
        // BÆ°á»›c 1: Adaptive filtering (loáº¡i bá» nhiá»…u tÆ°Æ¡ng quan)
        cleaned = adaptiveFilter.process(primary, reference);
        
        // BÆ°á»›c 2: Noise gate (loáº¡i bá» tÃ­n hiá»‡u yáº¿u)
        cleaned = noiseGate.process(cleaned);
        
        if (cleaned == 0) noiseCancelledSamples++;
      }
      
      processedBuffer[i] = cleaned;
    }
    
    // BÆ°á»›c 3: Spectral subtraction (náº¿u Ä‘Ã£ cÃ³ noise profile)
    if (ANC_ENABLE && spectralSubtractor.isReady()) {
      spectralSubtractor.process(processedBuffer, samplesRead);
    }
    
    // Ghi vÃ o file (Mono)
    size_t bytesToWrite = samplesRead * 2;
    file.write((uint8_t*)processedBuffer, bytesToWrite);
    totalDataSize += bytesToWrite;
    samplesRecorded += samplesRead;
    
    // Progress bar
    int progress = (samplesRecorded * 100) / totalSamples;
    if (progress % 20 == 0 && samplesRecorded % (SAMPLE_RATE / 2) == 0) {
      Serial.printf("â–“");
    }
  }

  unsigned long elapsed = millis() - startTime;
  float noiseReduction = (noiseCancelledSamples * 100.0) / samplesRecorded;
  
  Serial.println();
  Serial.printf("âœ… HoÃ n táº¥t! Thá»i gian: %lu ms\n", elapsed);
  Serial.printf("ğŸ“Š KÃ­ch thÆ°á»›c: %d KB\n", (totalDataSize + sizeof(WAVHeader))/1024);
  Serial.printf("ğŸ”‡ Nhiá»…u Ä‘Ã£ lá»c: %.1f%%\n", noiseReduction);

  file.seek(0);
  createWAVHeader(&header, totalDataSize);
  file.write((uint8_t*)&header, sizeof(WAVHeader));
  file.close();
}

String base64Encode(uint8_t* data, size_t len) {
  const char* base64Chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
  String encoded = "";
  encoded.reserve((len * 4) / 3 + 4);
  
  for (size_t i = 0; i < len; i += 3) {
    uint32_t b = (data[i] << 16) | ((i + 1 < len ? data[i + 1] : 0) << 8) | (i + 2 < len ? data[i + 2] : 0);
    encoded += base64Chars[(b >> 18) & 0x3F];
    encoded += base64Chars[(b >> 12) & 0x3F];
    encoded += (i + 1 < len) ? base64Chars[(b >> 6) & 0x3F] : '=';
    encoded += (i + 2 < len) ? base64Chars[b & 0x3F] : '=';
  }
  return encoded;
}

bool uploadToGoogleDrive(const char* filename) {
  File file = SPIFFS.open(filename, FILE_READ);
  if (!file) {
    Serial.println("âŒ KhÃ´ng thá»ƒ Ä‘á»c file!");
    return false;
  }

  Serial.println("â˜ï¸  ÄANG UPLOAD LÃŠN GOOGLE DRIVE...");
  
  size_t fileSize = file.size();
  Serial.printf("ğŸ“¦ KÃ­ch thÆ°á»›c file: %d bytes\n", fileSize);
  
  uint8_t* buffer = (uint8_t*)malloc(fileSize);
  if (!buffer) {
    Serial.println("âŒ KhÃ´ng Ä‘á»§ RAM!");
    file.close();
    return false;
  }
  
  file.read(buffer, fileSize);
  file.close();

  Serial.print("ğŸ”„ Äang mÃ£ hÃ³a... ");
  String encoded = "";
  size_t chunkSize = 3000;
  for (size_t i = 0; i < fileSize; i += chunkSize) {
    size_t len = min(chunkSize, fileSize - i);
    encoded += base64Encode(buffer + i, len);
    if (i % 15000 == 0) Serial.print(".");
  }
  free(buffer);
  Serial.println(" OK");

  String timestamp = String(millis());
  String jsonData = "{\"filename\":\"recording_ANC_" + timestamp + ".wav\",\"data\":\"" + encoded + "\"}";

  HTTPClient http;
  http.begin(scriptURL);
  http.addHeader("Content-Type", "application/json");
  http.setTimeout(30000);
  
  Serial.print("ğŸ“¤ Äang gá»­i... ");
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    String response = http.getString();
    Serial.println("OK");
    Serial.println("âœ… UPLOAD THÃ€NH CÃ”NG!");
    Serial.println("ğŸ”— Link file: " + response);
    http.end();
    return true;
  } else {
    Serial.println("THáº¤T Báº I");
    Serial.printf("âŒ MÃ£ lá»—i HTTP: %d\n", httpCode);
    http.end();
    return false;
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  ESP32-S DUAL MIC + ANC v2.0      â•‘");
  Serial.println("â•‘  Acoustic Noise Cancelling        â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  Serial.print("ğŸ’¾ Khá»Ÿi táº¡o SPIFFS... ");
  if (!SPIFFS.begin(true)) {
    Serial.println("THáº¤T Báº I!");
    while(1) delay(1000);
  }
  Serial.println("OK");
  
  Serial.printf("ğŸ“¶ Äang káº¿t ná»‘i WiFi: %s\n", ssid);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  Serial.println();
  
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âŒ KHÃ”NG THá»‚ Káº¾T Ná»I WIFI!");
    while(1) delay(1000);
  }
  
  Serial.println("âœ… ÄÃ£ káº¿t ná»‘i WiFi!");
  Serial.print("ğŸŒ IP: ");
  Serial.println(WiFi.localIP());
  
  Serial.println("\nğŸ›ï¸  Äang khá»Ÿi táº¡o I2S...");
  Serial.println("   â†’ MIC 1 (Primary): WS=15, SD=32, SCK=14");
  setupI2S(I2S_PORT_1, I2S_WS_1, I2S_SD_1, I2S_SCK_1);
  Serial.println("   â†’ MIC 2 (Reference): WS=25, SD=33, SCK=26");
  setupI2S(I2S_PORT_2, I2S_WS_2, I2S_SD_2, I2S_SCK_2);
  Serial.println("âœ… I2S sáºµn sÃ ng!\n");
  
  delay(1000);
  
  // Calibrate noise profile
  calibrateNoiseProfile();
  
  Serial.println("\nğŸš€ Há»† THá»NG Sáº´N SÃ€NG!\n");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  const char* audioFile = "/recording.wav";
  
  Serial.println("ğŸ¬ Báº®T Äáº¦U CHU Ká»² Má»šI");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  recordAudioWithANC(audioFile);
  
  Serial.println();
  
  if (uploadToGoogleDrive(audioFile)) {
    SPIFFS.remove(audioFile);
    Serial.println("ğŸ—‘ï¸  ÄÃ£ xÃ³a file táº¡m");
  }
  
  Serial.println("\nâ³ Chá» 10 giÃ¢y...");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  delay(10000);
}

/*
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              SETUP CHO Lá»šP Há»ŒC - HÆ¯á»šNG DáºªN CHI TIáº¾T                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ« Cáº¤U HÃŒNH Tá»I Æ¯U CHO Lá»šP Há»ŒC:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Vá»Š TRÃ Äáº¶T MIC:

     Cá»¬A Sá»”/Cá»¬A CHÃNH (nguá»“n á»“n)
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘   [MIC 2] â† 50cm tá»« cá»­a      â•‘  
  â•‘   â””â”€ HÆ°á»›ng RA NGOÃ€I          â•‘  â† Reference Mic
  â•‘      (báº¯t tiáº¿ng xe, giÃ³,     â•‘     (báº¯t tiáº¿ng á»“n bÃªn ngoÃ i)
  â•‘       ngÆ°á»i qua láº¡i)          â•‘
  â•‘                              â•‘
  â•‘        Lá»šP Há»ŒC              â•‘
  â•‘                              â•‘
  â•‘      ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn           â•‘
  â•‘      [MIC 1]                 â•‘  â† Primary Mic
  â•‘      â””â”€ 1-2m tá»« giÃ¡o viÃªn    â•‘     (báº¯t giá»ng giÃ¡o viÃªn)
  â•‘         (treo tráº§n/Ä‘áº·t bá»¥c)  â•‘
  â•‘                              â•‘
  â•‘    ğŸª‘ğŸª‘ğŸª‘ Há»c sinh            â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… MIC 1 (Primary - Trong lá»›p):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Vá»‹ trÃ­:
   - Gáº§n giÃ¡o viÃªn (1-2 mÃ©t)
   - Treo tráº§n hoáº·c Ä‘áº·t trÃªn bá»¥c giáº£ng
   - HÆ°á»›ng vá» phÃ­a giÃ¡o viÃªn
   - TrÃ¡nh gáº§n quáº¡t/mÃ¡y láº¡nh

ğŸ¯ Má»¥c Ä‘Ã­ch:
   - Báº¯t giá»ng giÃ¡o viÃªn rÃµ rÃ ng
   - Thu Ã¢m chÃ­nh cá»§a lá»›p há»c
   - Báº¯t cáº£ cÃ¢u há»i há»c sinh (náº¿u gáº§n)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… MIC 2 (Reference - NgoÃ i cá»­a):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Vá»‹ trÃ­:
   - Gáº§n cá»­a sá»•/cá»­a chÃ­nh (30-50cm)
   - HÆ¯á»šNG RA NGOÃ€I (quan trá»ng!)
   - CÃ³ thá»ƒ Ä‘áº·t gáº§n khe cá»­a
   - TrÃ¡nh bá»‹ che khuáº¥t

ğŸ¯ Má»¥c Ä‘Ã­ch:
   - Báº¯t tiáº¿ng á»“n tá»« ngoÃ i (xe cá»™, giÃ³, ngÆ°á»i Ä‘i láº¡i)
   - LÃ m tham chiáº¿u Ä‘á»ƒ loáº¡i bá» nhiá»…u
   - KHÃ”NG thu giá»ng giÃ¡o viÃªn

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš™ï¸ THAM Sá» ÄÃƒ ÄIá»€U CHá»ˆNH CHO Lá»šP Há»ŒC:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… NOISE_GATE_THRESHOLD = 400
   - Tháº¥p hÆ¡n Ä‘á»ƒ khÃ´ng máº¥t giá»ng giÃ¡o viÃªn
   - Váº«n Ä‘á»§ Ä‘á»ƒ lá»c nhiá»…u ná»n

âœ… ADAPTIVE_FILTER_SIZE = 48
   - TÄƒng lÃªn Ä‘á»ƒ lá»c tá»‘t hÆ¡n tiáº¿ng á»“n bÃªn ngoÃ i
   - Äá»§ lá»›n cho mÃ´i trÆ°á»ng lá»›p há»c

âœ… SMOOTHING_FACTOR = 0.92
   - Giáº£m xuá»‘ng Ä‘á»ƒ pháº£n á»©ng nhanh vá»›i giá»ng nÃ³i
   - KhÃ´ng bá» lá»¡ tá»« Ä‘áº§u cÃ¢u

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ›ï¸ CALIBRATION (Quan trá»ng cho lá»›p há»c!):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â° Thá»i Ä‘iá»ƒm tá»‘t nháº¥t Ä‘á»ƒ calibrate:
   âœ… TRÆ¯á»šC khi lá»›p há»c báº¯t Ä‘áº§u
   âœ… Khi lá»›p TRá»NG (khÃ´ng cÃ³ há»c sinh)
   âœ… Cá»¬A ÄÃ“NG (hoáº·c má»Ÿ nhÆ° khi dáº¡y)
   âœ… Quáº¡t/mÃ¡y láº¡nh Báº¬T (náº¿u dÃ¹ng khi dáº¡y)

ğŸ“ CÃ¡ch lÃ m:
   1. Reset ESP32
   2. Äá»£i thÃ´ng bÃ¡o "Giá»¯ im láº·ng 1 giÃ¢y"
   3. KHÃ”NG nÃ³i chuyá»‡n trong 1 giÃ¢y
   4. Há»‡ thá»‘ng há»c noise profile
   5. Sáºµn sÃ ng ghi Ã¢m!

ğŸ’¡ Máº¹o:
   - Calibrate má»—i sÃ¡ng trÆ°á»›c giá» há»c
   - Náº¿u Ä‘Ã³ng/má»Ÿ cá»­a â†’ Reset láº¡i
   - Náº¿u báº­t/táº¯t quáº¡t â†’ Reset láº¡i

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š LOáº I NHIá»„U Sáº¼ Bá»Š Lá»ŒC:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Hiá»‡u quáº£ cao (70-90% giáº£m):
   ğŸš— Tiáº¿ng xe cá»™ tá»« ngoÃ i Ä‘Æ°á»ng
   ğŸ’¨ Tiáº¿ng giÃ³, mÆ°a
   ğŸ‘¥ NgÆ°á»i Ä‘i láº¡i hÃ nh lang
   ğŸ”Š Tiáº¿ng loa phÃ³ng thanh xa
   ğŸ—ï¸ Tiáº¿ng xÃ¢y dá»±ng á»•n Ä‘á»‹nh

âš ï¸ Hiá»‡u quáº£ trung bÃ¬nh (40-60% giáº£m):
   ğŸ—£ï¸ NgÆ°á»i nÃ³i chuyá»‡n hÃ nh lang (gáº§n cá»­a)
   ğŸ“± Tiáº¿ng Ä‘iá»‡n thoáº¡i reo
   ğŸšª Tiáº¿ng Ä‘Ã³ng má»Ÿ cá»­a Ä‘á»™t ngá»™t

âŒ KhÃ³ lá»c:
   ğŸ˜‚ Tiáº¿ng cÆ°á»i/nÃ³i cá»§a há»c sinh TRONG lá»›p
   ğŸ“¢ Tiáº¿ng hÃ´ to Ä‘á»™t ngá»™t
   ğŸµ Nháº¡c tá»« lá»›p bÃªn (náº¿u quÃ¡ to)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”§ ÄIá»€U CHá»ˆNH Náº¾U Cáº¦N:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Náº¿u giá»ng giÃ¡o viÃªn bá»‹ nhá»/mÃ©o:
   â†’ Giáº£m NOISE_GATE_THRESHOLD xuá»‘ng 300
   â†’ Di chuyá»ƒn Mic 1 gáº§n giÃ¡o viÃªn hÆ¡n

Náº¿u váº«n nghe rÃµ tiáº¿ng xe ngoÃ i:
   â†’ TÄƒng ADAPTIVE_FILTER_SIZE lÃªn 64
   â†’ Di chuyá»ƒn Mic 2 gáº§n cá»­a hÆ¡n
   â†’ Äáº£m báº£o Mic 2 HÆ¯á»šNG RA NGOÃ€I

Náº¿u máº¥t tá»« Ä‘áº§u cÃ¢u:
   â†’ Giáº£m SMOOTHING_FACTOR xuá»‘ng 0.85
   â†’ Giáº£m NOISE_GATE_THRESHOLD xuá»‘ng 350

Náº¿u ESP32 cháº­m/lag:
   â†’ Giáº£m ADAPTIVE_FILTER_SIZE xuá»‘ng 32
   â†’ Giáº£m BUFFER_SIZE xuá»‘ng 256

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ TIPS THÃŠM CHO Lá»šP Há»ŒC:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. ğŸ¤ Náº¿u cÃ³ micro cho giÃ¡o viÃªn:
   - Äáº·t Mic 1 gáº§n loa micro
   - Hiá»‡u quáº£ tÄƒng lÃªn ráº¥t nhiá»u!

2. ğŸªŸ Náº¿u cÃ³ nhiá»u cá»­a sá»•:
   - Äáº·t Mic 2 gáº§n cá»­a á»“n nháº¥t
   - Hoáº·c dÃ¹ng 3-4 mic (nÃ¢ng cao)

3. ğŸ“¹ Káº¿t há»£p vá»›i camera:
   - Äá»“ng bá»™ audio + video
   - Táº¡o bÃ i giáº£ng online cháº¥t lÆ°á»£ng

4. â° Láº­p lá»‹ch tá»± Ä‘á»™ng:
   - Ghi Ã¢m theo giá» há»c
   - Tá»± Ä‘á»™ng upload lÃªn Drive
   - GiÃ¡o viÃªn chá»‰ cáº§n báº­t nguá»“n!

5. ğŸ”‹ Nguá»“n Ä‘iá»‡n:
   - DÃ¹ng adapter 5V á»•n Ä‘á»‹nh
   - KHÃ”NG dÃ¹ng pin (sáº½ háº¿t giá»¯a chá»«ng)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Káº¾T QUáº¢ MONG Äá»¢I:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Giá»ng giÃ¡o viÃªn rÃµ rÃ ng 
âœ… Giáº£m 70-80% tiáº¿ng á»“n ngoÃ i Ä‘Æ°á»ng
âœ… Lá»c Ä‘Æ°á»£c tiáº¿ng quáº¡t/mÃ¡y láº¡nh
âœ… File audio dá»… nghe, khÃ´ng má»‡t tai
âœ… PhÃ¹ há»£p lÃ m bÃ i giáº£ng online

ğŸ¯ Cháº¥t lÆ°á»£ng tÆ°Æ¡ng Ä‘Æ°Æ¡ng thu Ã¢m studio nhá»!

*/
